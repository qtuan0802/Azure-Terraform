name: 'Microsoft Fabric Infrastructure'

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'infra-lovepop-common/fabric/**'
  pull_request:
    branches:
      - main
    paths:
      - 'infra-lovepop-common/fabric/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  TF_VERSION: '1.6.0'
  WORKING_DIRECTORY: 'infra-lovepop-common/fabric'

jobs:
  validation:
    name: 'Validation'
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: 'Terraform Format Check'
        run: terraform fmt -check -recursive
      
      - name: 'Terraform Init'
        run: terraform init -backend=false
      
      - name: 'Terraform Validate'
        run: terraform validate
      
      - name: 'Run Security Scan'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: ${{ env.WORKING_DIRECTORY }}
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: 'Upload Security Scan Results'
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  plan-dev:
    name: 'Plan - Development'
    runs-on: ubuntu-latest
    needs: validation
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
      
      - name: 'Terraform Init'
        run: terraform init -backend-config=dev.tfbackend
      
      - name: 'Terraform Plan'
        run: terraform plan -var-file=dev.tfvars -out=tfplan-dev
      
      - name: 'Upload Plan Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-dev
          path: ${{ env.WORKING_DIRECTORY }}/tfplan-dev
          retention-days: 5
      
      - name: 'Comment PR with Plan'
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const { execSync } = require('child_process');
            const plan = execSync('terraform show -no-color tfplan-dev', { 
              cwd: '${{ env.WORKING_DIRECTORY }}',
              encoding: 'utf-8' 
            });
            
            const body = `## Terraform Plan - Development\n\`\`\`\n${plan}\n\`\`\``;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  apply-dev:
    name: 'Apply - Development'
    runs-on: ubuntu-latest
    needs: plan-dev
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev' && github.event.inputs.action == 'apply')
    environment: development
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
      
      - name: 'Terraform Init'
        run: terraform init -backend-config=dev.tfbackend
      
      - name: 'Download Plan Artifact'
        uses: actions/download-artifact@v4
        with:
          name: tfplan-dev
          path: ${{ env.WORKING_DIRECTORY }}
      
      - name: 'Terraform Apply'
        run: terraform apply -auto-approve tfplan-dev

  plan-staging:
    name: 'Plan - Staging'
    runs-on: ubuntu-latest
    needs: validation
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}
      
      - name: 'Terraform Init'
        run: terraform init -backend-config=staging.tfbackend
      
      - name: 'Terraform Plan'
        run: terraform plan -var-file=staging.tfvars -out=tfplan-staging
      
      - name: 'Upload Plan Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-staging
          path: ${{ env.WORKING_DIRECTORY }}/tfplan-staging
          retention-days: 5

  apply-staging:
    name: 'Apply - Staging'
    runs-on: ubuntu-latest
    needs: plan-staging
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging' && github.event.inputs.action == 'apply')
    environment: staging
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}
      
      - name: 'Terraform Init'
        run: terraform init -backend-config=staging.tfbackend
      
      - name: 'Download Plan Artifact'
        uses: actions/download-artifact@v4
        with:
          name: tfplan-staging
          path: ${{ env.WORKING_DIRECTORY }}
      
      - name: 'Terraform Apply'
        run: terraform apply -auto-approve tfplan-staging

  plan-prod:
    name: 'Plan - Production'
    runs-on: ubuntu-latest
    needs: [validation, apply-staging]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
      
      - name: 'Terraform Init'
        run: terraform init -backend-config=prod.tfbackend
      
      - name: 'Terraform Plan'
        run: terraform plan -var-file=prod.tfvars -out=tfplan-prod
      
      - name: 'Upload Plan Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-prod
          path: ${{ env.WORKING_DIRECTORY }}/tfplan-prod
          retention-days: 30

  apply-prod:
    name: 'Apply - Production'
    runs-on: ubuntu-latest
    needs: plan-prod
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod' && github.event.inputs.action == 'apply'
    environment: production
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
      
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
      
      - name: 'Terraform Init'
        run: terraform init -backend-config=prod.tfbackend
      
      - name: 'Download Plan Artifact'
        uses: actions/download-artifact@v4
        with:
          name: tfplan-prod
          path: ${{ env.WORKING_DIRECTORY }}
      
      - name: 'Terraform Apply'
        run: terraform apply -auto-approve tfplan-prod
      
      - name: 'Notify Teams on Success'
        uses: 8398a7/action-slack@v3
        if: success()
        with:
          status: custom
          custom_payload: |
            {
              "text": "✅ Microsoft Fabric Production Deployment Successful",
              "attachments": [{
                "color": "good",
                "fields": [{
                  "title": "Environment",
                  "value": "Production",
                  "short": true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: 'Notify Teams on Failure'
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: custom
          custom_payload: |
            {
              "text": "❌ Microsoft Fabric Production Deployment Failed",
              "attachments": [{
                "color": "danger",
                "fields": [{
                  "title": "Environment",
                  "value": "Production",
                  "short": true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}